<div class="app-container">
  <div fxLayout="row" fxLayoutGap="32px" class="app-account-wrapper">
    <div class="app-left app-fx-facets">
      <div class="app-facets-used">
        <mat-list *ngIf="stateFilter?.length || newStavFilter?.length || institutionFilter?.length || delegatedFilter?.length || priorityFilter?.length || typeOfRequestFilter?.length">
          <h3 matSubheader fxLayout="row">
            <div fxFlex>{{ 'desc.pouzite_filtry' | translate }}</div>
            <a [matTooltip]="'desc.odstranit_vsechny_filtry' | translate" matTooltipPosition="above" (click)="removeAllFilters()"><mat-icon class="material-icons-outlined">highlight_off</mat-icon></a>
          </h3>
          <div class="app-list-content-wrapper">
            <ng-container *ngFor="let filter of filterState">
              <mat-list-item *ngIf="stateFilter === filter.id">
                <a [matTooltip]="'desc.odstranit_tento_filtr' | translate" matTooltipPosition="above" (click)="setStavZadosti(filter.id)"><mat-icon>clear</mat-icon></a>
                <div>
                  <span>{{ 'desc.stav_zadosti' | translate }}:</span> {{ 'desc.' + filter.val | translate }}
                </div>
              </mat-list-item>
            </ng-container>
            <ng-container *ngFor="let filter of filterType">
              <mat-list-item *ngIf="newStavFilter === filter.id">
                <a [matTooltip]="'desc.odstranit_tento_filtr' | translate" matTooltipPosition="above" (click)="setStav(filter.id)"><mat-icon>clear</mat-icon></a>
                <div>
                  <span>{{ 'desc.typ_navrhu' | translate }}:</span> {{ 'desc.' + filter.val | translate }}
                </div>
              </mat-list-item>
            </ng-container>  
            <ng-container *ngIf="institutionFilter">
              <mat-list-item>
                <a [matTooltip]="'desc.odstranit_tento_filtr' | translate" matTooltipPosition="above" (click)="setInstitution(institutionFilter)"><mat-icon>clear</mat-icon></a>
                <div>
                  <span>{{ 'desc.institution' | translate }}:</span> {{institutionFilter }}
                </div>
              </mat-list-item>
            </ng-container>  
            <ng-container *ngIf="delegatedFilter">
              <mat-list-item>
                <a [matTooltip]="'desc.odstranit_tento_filtr' | translate" matTooltipPosition="above" (click)="setDelegated(delegatedFilter)"><mat-icon>clear</mat-icon></a>
                <div>
                  <span>{{ 'desc.delegated_kurator' | translate }}:</span> {{delegatedFilter }}
                </div>
              </mat-list-item>
            </ng-container>  
            <ng-container *ngIf="priorityFilter">
              <mat-list-item>
                <a [matTooltip]="'desc.odstranit_tento_filtr' | translate" matTooltipPosition="above" (click)="setPriority(priorityFilter)"><mat-icon>clear</mat-icon></a>
                <div>
                  <span>{{ 'desc.priority' | translate }}:</span> {{priorityFilter }}
                </div>
              </mat-list-item>
            </ng-container>
            <ng-container *ngIf="typeOfRequestFilter">
              <mat-list-item>
                <a [matTooltip]="'desc.odstranit_tento_filtr' | translate" matTooltipPosition="above" (click)="setTypeOfRequest(typeOfRequestFilter)"><mat-icon>clear</mat-icon></a>
                <div>
                  <span>{{ 'desc.type_of_request' | translate }}:</span> {{ 'desc.'+typeOfRequestFilter+'_type_request' | translate }}
                </div>
              </mat-list-item>
            </ng-container>  
          </div>
        </mat-list>
      </div>

      <mat-accordion multi>
        <mat-expansion-panel [expanded]="true">
          <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
            <mat-panel-title>
              {{ 'desc.stav_zadosti' | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngIf="stateFilter !== 'open'">
            <a (click)="setStavZadosti('open')">{{ 'desc.neodeslano' | translate }}</a>
          </div>
          <div *ngIf="stateFilter !== 'waiting'">
            <a (click)="setStavZadosti('waiting')">{{ 'desc.ceka_na_posouzeni' | translate }}</a>
          </div>
          <div *ngIf="stateFilter !== 'waiting_for_automatic_process'">
            <a (click)="setStavZadosti('waiting_for_automatic_process')">{{ 'desc.ceka_na_automaticke_zpracovani' | translate }}</a>
          </div>
          <div *ngIf="stateFilter !== 'processed'">
            <a (click)="setStavZadosti('processed')">{{ 'desc.zpracovano' | translate }}</a>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel [expanded]="true">
          <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
            <mat-panel-title>
              {{ 'desc.typ_navrhu' | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngIf="newStavFilter !== 'NZN'">
            <a (click)="setStav('NZN')">{{ 'desc.navrzeno_na_zarazeni' | translate }}</a>
          </div>
          <div *ngIf="newStavFilter !== 'VN'">
            <a (click)="setStav('VN')">{{ 'desc.navrzeno_na_vyrazeni' | translate }}</a>
          </div>
          <div *ngIf="newStavFilter !== 'VNL'">
            <a (click)="setStav('VNL')">{{ 'desc.navrzeno_na_omezeni_vnl' | translate }}</a>
          </div>
          <div *ngIf="newStavFilter !== 'VNZ'">
            <a (click)="setStav('VNZ')">{{ 'desc.navrzeno_na_omezeni_vnz' | translate }}</a>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel [expanded]="true"  *ngIf="allResultInstitutions.length > 0 && (state.user.role === 'kurator' || state.user.role === 'mainKurator')">
          <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
            <mat-panel-title>
              {{ 'desc.institution' | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngFor="let inst of allResultInstitutions">
            <a (click)="setInstitution(inst)">{{ inst }}</a>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel [expanded]="true"  *ngIf="allPriorities.length > 0 && (state.user.role === 'kurator' || state.user.role === 'mainKurator')">
          <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
            <mat-panel-title>
              {{ 'desc.priority' | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngFor="let p of allPriorities">
            <a (click)="setPriority(p)">{{ p }}</a>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel [expanded]="true"  *ngIf="allDelegated.length > 0 && (state.user.role === 'kurator' || state.user.role === 'mainKurator')">
          <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
            <mat-panel-title>
              {{ 'desc.delegated_kurator' | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngFor="let d of allDelegated">
            <a (click)="setDelegated(d)">{{ d }}</a>
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel [expanded]="true"  *ngIf="allTypes.length > 0 && (state.user.role === 'kurator' || state.user.role === 'mainKurator')">
          <mat-expansion-panel-header expandedHeight="48px" collapsedHeight="48px">
            <mat-panel-title>
              {{ 'desc.typ_zadosti' | translate }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div *ngFor="let d of allTypes">
            <a (click)="setTypeOfRequest(d)">{{ 'desc.'+d+'_type_request' | translate }}</a>
          </div>
        </mat-expansion-panel>

      </mat-accordion>
    </div>


    <div fxFlex class="app-right">
      <div fxLayout="row wrap" fxLayoutGap="32px" fxLayoutAlign="start center" class="app-toolbar">
        <div fxFlex class="app-left">
          {{ 'desc.num_found' | translate }}: <strong>{{ numFound }}</strong>
        </div>
        <div class="app-right">
          <app-paginator [numFound]="numFound"  [showSort]="true" [sortType]="(state.user.role === 'kurator' || state.user.role === 'mainKurator' || state.user.role === 'admin')  ?   'sort_account':  'user_sort_account'"></app-paginator>
        </div>
      </div>

      <div class="app-results-wrapper app-overflow-x-auto">
        <table mat-table [dataSource]="zadosti" class="mat-elevation-z0">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.id' | translate }}</th>
            <td mat-cell *matCellDef="let element">
              <span [matTooltip]="element.id">{{ element.id.substring(element.id.length -8) }}</span>
            </td>
          </ng-container>
          <ng-container matColumnDef="version">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.version' | translate }}</th>
            <td mat-cell *matCellDef="let element">
              <span [matTooltip]="element.id">{{  element.version.substring(element.version.length -8)  }}</span>
            </td>
          </ng-container>
          <ng-container matColumnDef="datum_zadani">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.datum_zadani' | translate }}</th>
            <td mat-cell *matCellDef="let element" [matTooltip]="element.datum_zadani | date : 'dd.MM.yyyy HH:mm'">{{ element.datum_zadani | date : 'dd.MM.yyyy' }}</td>
          </ng-container>
          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef [hidden]="(state.user.role !== 'kurator' && state.user.role !== 'mainKurator')">{{ 'desc.uzivatel' | translate }}</th>
            <td mat-cell *matCellDef="let element" [hidden]="(state.user.role !== 'kurator' && state.user.role !== 'mainKurator')">{{ element.user }}</td>
          </ng-container>
          <!-- <ng-container matColumnDef="institution">
            <th mat-header-cell *matHeaderCellDef [hidden]="(state.user.role !== 'kurator' && state.user.role !== 'mainKurator')">{{ 'desc.institution' | translate }}</th>
            <td mat-cell *matCellDef="let element" [hidden]="(state.user.role !== 'kurator' && state.user.role !== 'mainKurator')">{{ element.institution }}</td>
          </ng-container> -->
          <ng-container matColumnDef="state">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.stav' | translate }}</th>
            <td mat-cell *matCellDef="let element" class="app-pr-2">
              <mat-icon class="material-icons-outlined" [class]="element.state" [matTooltip]="'state.' + element.state | translate" matTooltip="above">
                <ng-container *ngIf="element.state === 'open'">lock_open</ng-container>
                <ng-container *ngIf="element.state === 'waiting'"><!-- schedule_send -->lock_clock</ng-container>
                <ng-container *ngIf="element.state === 'processed'">lock</ng-container>
                <ng-container *ngIf="element.state === 'waiting_for_automatic_process'">hourglass_bottom</ng-container>
              </mat-icon>
            </td>
          </ng-container>
          <ng-container matColumnDef="navrh">
            <th mat-header-cell *matHeaderCellDef><!-- {{ 'desc.navhr_na_stav' | translate }} --></th>
            <td mat-cell *matCellDef="let element">
              <span [class]="'app-badge app-mr-1 ' +  element.navrh" [matTooltip]="'state.tooltip.' + element.navrh | translate">{{ element.navrh }}</span>
            </td>
          </ng-container>
          <ng-container matColumnDef="datum_vyrizeni">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.datum_vyrizeni' | translate }}</th>
            <td mat-cell *matCellDef="let element" [matTooltip]="element.datum_vyrizeni | date : 'dd.MM.yyyy HH:mm'">{{ element.datum_vyrizeni | date : 'dd.MM.yyyy'  }}</td>
          </ng-container>
          <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.pocet_zadosti' | translate }}</th>
            <td mat-cell *matCellDef="let element">{{ element.identifiers?.length }} -  ({{ countProcessed(element) }})</td>
          </ng-container>
          <ng-container matColumnDef="deadline">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.deadline' | translate }}</th>
            <td mat-cell *matCellDef="let element" [matTooltip]="element.deadline | date : 'dd.MM.yyyy HH:mm'">{{ element.deadline | date : 'dd.MM.yyyy' }}</td>
          </ng-container>
          <ng-container matColumnDef="period">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.period' | translate }}</th>
            <td mat-cell *matCellDef="let element">{{ element.type_of_period ?  ('desc.'+element.type_of_period | translate) : '' }}</td>
          </ng-container>
          <ng-container matColumnDef="desiredstate">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.desiredstate' | translate }}</th>
            <td mat-cell *matCellDef="let element">{{ element.desired_item_state && element.desired_license ? ""+element.desired_item_state+" - ("+element.desired_license+")" : (element.desired_item_state ? ""+element.desired_item_state : "") }}</td>
          </ng-container>
          <ng-container matColumnDef="pozadavek">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.oduvodneni' | translate }}</th>
            <td mat-cell *matCellDef="let element" [matTooltip]="element.pozadavek" matTooltipPosition="above">
              <div class="app-text-cutter">
                {{ element.pozadavek }}
              </div>
            </td>
          </ng-container>
          <ng-container matColumnDef="poznamka">
            <th mat-header-cell *matHeaderCellDef>{{ 'desc.poznamka' | translate }}</th>
            <td mat-cell *matCellDef="let element" [matTooltip]="element.poznamka" matTooltipPosition="above">
              <div class="app-text-cutter">
                {{ element.poznamka }}
              </div>
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let element" class="app-text-right">
              <mat-button-toggle-group>
                <mat-button-toggle (click)="showRecords(element)" [matTooltip]="(state.user.role === 'kurator' || state.user.role === 'mainKurator') && element.state === 'waiting' ? ('desc.zpracovani_zadosti' | translate) : ('desc.prehled_zadosti' | translate)" matTooltipPosition="above">
                  <mat-icon class="material-icons-outlined">{{ (state.user.role === 'kurator' || state.user.role === 'mainKurator' ) && element.state === 'waiting' ? 'rule' : 'visibility' }}</mat-icon>
                </mat-button-toggle>
                <mat-button-toggle *ngIf="element.state === 'open'" (click)="send(element)"  [disabled]="!element.identifiers"  [matTooltip]="'desc.poslat_zadost' | translate" matTooltipPosition="above">
                  <mat-icon class="material-icons-outlined">send</mat-icon>
                </mat-button-toggle>
                <mat-button-toggle *ngIf="element.state === 'waiting' && (state.user.role === 'kurator' || state.user.role === 'mainKurator')" (click)="process(element)" [matTooltip]="'desc.oznacit_jako_zpracovane' | translate" matTooltipPosition="above">
                  <mat-icon class="material-icons-outlined">done</mat-icon>
                </mat-button-toggle>
                <mat-button-toggle  *ngIf="((state.user.role === 'user' || state.user.role === 'knihovna') && element.state === 'open')" [matTooltip]="'desc.smazat_zadost' | translate" matTooltipPosition="above" (click)="confirmDeleteRequest(element)">
                  <mat-icon class="material-icons-outlined app-color-warning">clear</mat-icon>
                </mat-button-toggle>
              </mat-button-toggle-group>
            </td>
          </ng-container>
      
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.escalated]="escalated" [class.expired]="expired" 
            [ngClass]="{'escalated': isEscalated(row), 'expired': isExpired(row) }"></tr>
        </table>
      </div>
      <div class="app-mt-4">
        <app-paginator [numFound]="numFound" [showSort]="false" ></app-paginator>
      </div>
    </div>
  </div>
</div>
